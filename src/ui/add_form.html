<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="stylesheet" href="/src/ui/css/add_form.css" />
		<title>Add / Edit Client</title>
	</head>
	<body x-data="{ open: false }">
		<header class="header">
			<a class="logo" href="#hero">QRCode Gen</a>
			<nav class="nav">
				<ul class="navbar">
					<li><a href="/src/ui/indexey.html">Home</a></li>
					<!-- <li><a href="#about">About</a></li>
					<li><a href="#FAQ">FAQ's</a></li>
					<li><a href="#footer">Contact Us</a></li> -->
					<li><a href="/src/ui/signin_form.html">SigIn</a></li>
				</ul>
				<!-- menu hamburger -->
				<!-- <div id="webapp_cover">
					<div id="menu_button">
						<input type="checkbox" id="menu_checkbox" />
						<label for="menu_checkbox" id="menu_label">
							<div id="menu_text_bar"></div>
						</label>
					</div>
				</div> -->
			</nav>
		</header>
		<section class="modal" x-show="open">
			<div class="modal__overlay">
				<div class="modal__overlay__1"></div>
				<div class="modal__overlay__2"></div>
			</div>
			<div class="signin">
				<div class="content">
					<h2>Add / Edit Client</h2>
					<div id="form" class="form">
						<div class="inputBox">
							<input type="text" id="name" value="" required />
							<i>Name</i>
						</div>
						<div class="inputBox">
							<input type="text" id="nif" required />
							<i>NIF</i>
						</div>
						<div class="inputBox">
							<input type="text" id="address" required />
							<i>Address</i>
						</div>
						<div class="inputBox">
							<input type="email" id="mail" value="" required />
							<i>Mail</i>
						</div>
						<div class="inputBox">
							<input type="text" id="phone" required />
							<i>Phone</i>
						</div>
						<div class="inputBox">
							<input type="password" id="pass" value="" required />
							<i>Password</i>
						</div>
						<div class="inputBox">
							<input type="password" id="confirmPass" value="" required />
							<i>Confirm Password</i>
						</div>
						<div class="inputBox">
							<button id="submit_form" class="submit" type="submit">+ Add New</button>
						</div>
					</div>
				</div>
			</div>
		</section>
		<footer id="footer" class="footer">
			<p>2024 an X Company Website, All Rights Reserved</p>
			<ul>
				<li><a href="#" class="facebook">Facebook</a></li>
				<li><a href="#" class="instagram">Instagram</a></li>
				<li><a href="#" class="linkedin">Linkedin</a></li>
				<li><a href="#" class="youtube">Youtube</a></li>
			</ul>
		</footer>
		<script>
			//    *** ADD / EDIT PROCESS ***

			document.addEventListener('DOMContentLoaded', () => {
				const signupForm = document.getElementById('form');
				const button = document.getElementById('submit_form');

				const _searchParams = new URLSearchParams(location.search);
				let item_id = null;
				if (_searchParams.has('id')) {
					item_id = _searchParams.get('id');
				}

				if (item_id != null) {
					loadData(item_id);
				}

				async function get_item_to_update(item) {
					document.getElementById('name').value = item.name;
					document.getElementById('nif').value = item.nif;
				}
				async function loadData(id, data, data) {
					let result = await fetch(`http://localhost:3003/user/${id}`, {
						method: 'GET',
						headers: {
							'Content-Type': 'application/json',
						},
					});
					var user = await result.json();
					get_item_to_update(user);
				}

				button.addEventListener('click', async event => {
					event.preventDefault();
					const name = document.getElementById('name').value;
					const nif = document.getElementById('nif').value;
					const address = document.getElementById('address').value;
					const email = document.getElementById('mail').value;
					const phone = document.getElementById('phone').value;
					const password = document.getElementById('pass').value;
					const confirmPassword = document.getElementById('confirmPass').value;

					// Dados validados, recolhidos para o backend:

					const formData = {
						name: name,
						nif: nif,
						address: address,
						email: email,
						phone: phone,
						password: password,
						confirmPassword: confirmPassword,
					};
					//decide if create or update

					if (item_id == null) {
						create_button(formData);
					} else {
						update_button(formData);
					}
				});
				async function update_button(formData) {
					try {
						// confirmar o http
						const response = await fetch('http://localhost:3003/user', {
							method: 'PATCH',
							headers: {
								'Content-Type': 'application/json',
							},
							body: JSON.stringify(formData),
						});

						if (response.ok) {
							// mandar dados para base de dados MongoDB e para a tabela HTML table_data
							formData.send.tbody;
							// A intenção é redirecionar para a página de Home a fazer já o QR Code pretendido
							window.location.href = '/src/ui/table_data_users.html';

							response.status(200).send('User updated / created with success!');
							console.log('User created with success!');
						} else {
							response.status(404).send('Erro ao criar utilizador! Tente novamente!');
							console.log('Erro ao criar utilizador', response.statusText);
						}
					} catch (error) {
						console.log('Erro de rede:', error);
					}
				}

				async function create_button(formData) {
					try {
						// confirmar o http
						const response = await fetch('http://localhost:3003/user', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json',
							},
							body: JSON.stringify(formData),
						});

						if (response.ok) {
							// mandar dados para base de dados MongoDB e para a tabela HTML table_data
							formData.send.tbody;
							// A intenção é redirecionar para a página de Home a fazer já o QR Code pretendido
							window.location.href = '/src/ui/table_data_users.html';

							response.status(200).send('User updated / created with success!');
							console.log('User created with success!');
						} else {
							response.status(404).send('Erro ao criar utilizador! Tente novamente!');
							console.log('Erro ao criar utilizador', response.statusText);
						}
					} catch (error) {
						console.log('Erro de rede:', error);
					}
				}
			});
		</script>
	</body>
</html>
